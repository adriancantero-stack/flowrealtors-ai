generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model WhatsAppSettings {
  id                  Int      @id @default(autoincrement())
  provider            String   @default("cloud-api") // "cloud-api" | "360dialog"
  api_token           String
  phone_number_id     String
  business_account_id String?
  verify_token        String
  enabled             Boolean  @default(false)
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())
}

model AISettings {
  id            Int      @id @default(autoincrement())
  api_key       String
  default_model String   @default("gemini-flash-latest")
  strong_model  String   @default("gemini-pro-latest")
  temperature   Float    @default(0.7)
  max_tokens    Int      @default(1000)
  system_prompt String?
  updatedAt     DateTime @updatedAt
}

model Lead {
  id           Int      @id @default(autoincrement())
  name         String?
  email        String?
  phone        String   @unique
  status       String   @default("new") // new, qualified, contacted, scheduled
  language     String   @default("en")
  intent       String?
  source       String?  @default("whatsapp")
  budget       String?
  desired_city String?
  
  brokerId     Int?
  broker       User?    @relation(fields: [brokerId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  messages     LeadMessage[]
}

model LeadMessage {
  id        Int      @id @default(autoincrement())
  leadId    Int
  lead      Lead     @relation(fields: [leadId], references: [id])
  role      String   // "user" | "assistant" | "system"
  content   String
  timestamp DateTime @default(now())
}

model User {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  password_hash String?
  phone         String?
  city          String?
  state         String?
  photo_url     String?
  calendly_link String?
  default_lang  String   @default("pt") // en, es, pt
  role          String   @default("broker") // broker, admin
  status        String   @default("active") // active, inactive
  
  // Multi-Tenant / Slug Support
  slug          String?  @unique // Nullable initially for backfill, but should be required later
  
  // WhatsApp Integration per Broker
  whatsapp_phone_number_id     String?
  whatsapp_business_account_id String?
  whatsapp_provider            String?  @default("cloud-api")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  leads         Lead[]
}

model SaaSSettings {
  id               Int      @id @default(autoincrement())
  platform_name    String   @default("FlowRealtors")
  base_domain      String?
  logo_url         String?
  active_languages String[]
  updatedAt        DateTime @updatedAt
}

model SystemLog {
  id        Int      @id @default(autoincrement())
  type      String   // AI, ERROR, WHATSAPP, SYSTEM
  action    String
  details   String?  // JSON or text
  status    String   // success, failure
  createdAt DateTime @default(now())
}

model AILog {
  id              Int      @id @default(autoincrement())
  model           String
  prompt_preview  String
  response_preview String
  createdAt       DateTime @default(now())
}
